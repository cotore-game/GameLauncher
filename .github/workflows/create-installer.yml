name: Create Installer

on:
  workflow_call:
    inputs:
      version:
        description: 'Installer version'
        required: true
        type: string
      unity-artifact-name:
        description: 'Unity build artifact name to download'
        required: true
        type: string
    outputs:
      installer-name:
        description: "Installer file name"
        value: ${{ jobs.create-installer.outputs.installer-name }}

jobs:
  create-installer:
    name: Package with Inno Setup
    runs-on: windows-latest
    outputs:
      installer-name: ${{ steps.set-output.outputs.installer-name }}
    
    steps:
      - name: Download Unity Build
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.unity-artifact-name }}
          path: build/StandaloneWindows64/

      - name: Remove Development-Only Folders
        shell: powershell
        run: |
          # DoNotShipフォルダとバックアップフォルダを削除
          Get-ChildItem -Path "build/StandaloneWindows64" -Recurse -Directory | 
            Where-Object { 
              $_.Name -like "*DoNotShip*" -or 
              $_.Name -like "*_BackUpThisFolder_ButDontShipItWithYourGame" 
            } | 
            ForEach-Object {
              Write-Host "Removing: $($_.FullName)"
              Remove-Item -Path $_.FullName -Recurse -Force
            }
          
          Write-Host "Development folders removed successfully"

      - name: Install Inno Setup
        shell: powershell
        run: |
          choco install innosetup -y

      - name: Create Installer Script
        shell: powershell
        run: |
          $version = "${{ inputs.version }}"
          $script = @"
          ; Game Launcher Installer Script
          ; Generated by GitHub Actions
          
          [Setup]
          ; アプリケーション情報
          AppName=Game Launcher
          AppVersion=$version
          AppPublisher=cotore-game
          AppPublisherURL=https://github.com/${{ github.repository }}
          AppSupportURL=https://github.com/${{ github.repository }}/issues
          AppUpdatesURL=https://github.com/${{ github.repository }}/releases
          
          ; インストール先
          DefaultDirName={autopf}\GameLauncher
          DefaultGroupName=Game Launcher
          
          ; 出力設定
          OutputDir=installer
          OutputBaseFilename=GameLauncher-Setup-v$version
          
          ; 圧縮設定
          Compression=lzma2
          SolidCompression=yes
          
          ; アーキテクチャ
          ArchitecturesInstallIn64BitMode=x64
          ArchitecturesAllowed=x64
          
          ; アンインストール情報
          UninstallDisplayName=Game Launcher
          UninstallDisplayIcon={app}\GameLauncher.exe
          
          ; ライセンス・情報ファイル
          ; LicenseFile=LICENSE.txt
          ; InfoBeforeFile=README.txt
          
          ; ウィザード設定
          WizardStyle=modern
          DisableProgramGroupPage=yes
          
          ; 言語選択
          ShowLanguageDialog=auto
          
          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"
          Name: "japanese"; MessagesFile: "compiler:Languages\Japanese.isl"
          
          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
          Name: "quicklaunchicon"; Description: "{cm:CreateQuickLaunchIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked; OnlyBelowVersion: 6.1; Check: not IsAdminInstallMode
          
          [Files]
          Source: "build\StandaloneWindows64\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs
          
          [Icons]
          ; スタートメニュー
          Name: "{group}\Game Launcher"; Filename: "{app}\GameLauncher.exe"
          Name: "{group}\{cm:UninstallProgram,Game Launcher}"; Filename: "{uninstallexe}"
          
          ; デスクトップアイコン（ユーザーが選択した場合のみ）
          Name: "{autodesktop}\Game Launcher"; Filename: "{app}\GameLauncher.exe"; Tasks: desktopicon
          
          ; クイック起動（ユーザーが選択した場合のみ、Windows 7以前）
          Name: "{userappdata}\Microsoft\Internet Explorer\Quick Launch\Game Launcher"; Filename: "{app}\GameLauncher.exe"; Tasks: quicklaunchicon
          
          [Run]
          Filename: "{app}\GameLauncher.exe"; Description: "{cm:LaunchProgram,Game Launcher}"; Flags: nowait postinstall skipifsilent
          
          [CustomMessages]
          english.LaunchProgram=Launch %1
          japanese.LaunchProgram=%1 を起動する
          "@
          
          New-Item -ItemType Directory -Force -Path installer
          $script | Out-File -FilePath "installer-script.iss" -Encoding UTF8

      - name: Build Installer
        shell: powershell
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer-script.iss

      - name: Set Output
        id: set-output
        shell: bash
        run: |
          INSTALLER_NAME="GameLauncher-Setup-v${{ inputs.version }}.exe"
          echo "installer-name=${INSTALLER_NAME}" >> $GITHUB_OUTPUT

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: installer-v${{ inputs.version }}
          path: installer/GameLauncher-Setup-v${{ inputs.version }}.exe
          retention-days: 1
